@{
    ViewData["Title"] = "Company";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content ListPage pt-1">
    <div class="page-header">
        <div class="page-title">
            <h4>Company Management</h4>
            <h6>Add/Update Company</h6>
        </div>
        <div class="page-btn">
            <div class="wordset newwordset">
                <ul>
                    <li>
                        <a data-bs-toggle="tooltip" data-bs-placement="top" title="Word" id="convertWord">
                            <i class="far fa-file-word" style="color: #1265c3; font-size:21px;"></i>
                        </a>
                    </li>
                    <li>
                        <a data-bs-toggle="tooltip" data-bs-placement="top" title="PDF" id="pdfPrint">
                            <i class="far fa-file-pdf" style="color: #ea5455; font-size:21px;"></i>
                        </a>
                    </li>
                    <li>
                        <a data-bs-toggle="tooltip" data-bs-placement="top" title="Excel" id="convertExcel">
                            <i class="far fa-file-excel" style="color: #28c76f; font-size:21px;"></i>
                        </a>
                    </li>
                    <li>
                        <a data-bs-toggle="tooltip" data-bs-placement="top" title="CSV" id="convertCsv">
                            <i class="fa-solid fa-file-csv" style="color: #28c76f; font-size:21px;"></i>
                        </a>
                    </li>
                    <li>
                        <a href="/Home/Index" role="button">
                            <i class="fas fa-times-circle fs-22" style="color: #ff0000;"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-top table-topm">
                <div class="search-set">
                    <div class="search-path">
                        <a class="btn btn-filter" id="filter_search_rm">
                            <img src="~/assets/img/icons/filter.svg" alt="img">
                            <span><img src="~/assets/img/icons/closes.svg" alt="img"></span>
                        </a>
                    </div>
                    <div class="search-input">
                        <input type="search" id="txtSearch" class="rounded-pill">
                    </div>
                </div>
                <div class="wordset">
                    <p href="javascript:void(0);" class="btn btn-addednew btnAdd ct-btns">
                        <img src="~/assets/img/icons/plus.svg" alt="img" class="me-1">Add New
                    </p>
                </div>
            </div>

            <div class="table-responsive" style="height:395px;">
                <table class="table text-white table-hover" id="tbl-print">
                    <thead>
                        <tr>
                            <th class="ps-2"><input type="checkbox" checked class="printCheckBox notPrintCol" />Id</th>
                            <th class="pe-3"><input type="checkbox" checked class="printCheckBox notPrintCol" />Name</th>
                            <th class="pe-3"><input type="checkbox" checked class="printCheckBox notPrintCol" />Email</th>
                            <th class="pe-3"><input type="checkbox" checked class="printCheckBox notPrintCol" />Telephone</th>
                            <th class="pe-3"><input type="checkbox" checked class="printCheckBox notPrintCol" />City</th>
                            <th class="pe-3"><input type="checkbox" checked class="printCheckBox notPrintCol" />Postal Code</th>
                            <th class="pe-3"><input type="checkbox" checked class="printCheckBox notPrintCol" />Address 1</th>
                            <th class="pe-3"><input type="checkbox" checked class="printCheckBox notPrintCol" />Address 2</th>
                            <th class="pe-3"><input type="checkbox" checked class="printCheckBox notPrintCol" />AutoPilot</th>
                            <th class="text-center pe-3 last-th-sticky"><input type="checkbox" class="printCheckBox notPrintCol" hidden>Action</th>
                        </tr>
                    </thead>
                    <tbody id="companyList">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="content AddPage pt-1">
    <div class="page-header">
        <div class="page-title">
            <h4>Company Add</h4>
        </div>
        <div class="page-btn">
            <a href="javascript:void(0);" class="btn btn-added btnList ct-btns">
                <i class="fa me-2 fa-th-list" data-bs-toggle="tooltip" title="" data-bs-original-title="" aria-label="fa fa-th-list"></i> Companies
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-lg-8 col-md-8 col-sm-12">
                    <div class="row activeForm disabled">
                        
                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group">
                                <label>Company</label>
                                <input type="text" class="rounded-pill" id="txtCompany" skinid="Enter Company ....!">
                                <input type="hidden" id="txtCompanyId" />
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="text" class="rounded-pill" id="txtEmail" skinid="Enter Email ....!">
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group">
                                <label>Telephone</label>
                                <input type="text" class="rounded-pill" id="txtTelephone" skinid="Enter Telephone ....!">
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" class="rounded-pill" id="txtCity" skinid="">
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group">
                                <label>Postal Code</label>
                                <input type="text" class="rounded-pill" id="txtPostalCode" skinid="">
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group">
                                <label>Address 1</label>
                                <input type="text" class="rounded-pill" id="txtAddress1" skinid="">
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group">
                                <label>Address 2</label>
                                <input type="text" class="rounded-pill" id="txtAddress2" skinid="">
                            </div>
                        </div>
                        
                        <div class="col-lg-6 col-md-6 col-sm-12">
                            <div class="form-group">
                                <label>Auto Pilot</label>
                                <input type="checkbox" id="txtAutoPilot" style="margin-top:14px; height:19px; width:19px;" skinid="" />
                            </div>
                        </div>

                    </div>

                    <div class="col-12 col-md-12 col-lg-12">
                        <div class="mb-2">
                            <button class="btn btn-primary btn-sm ct-btns" id="btnNewCompany">New</button>
                            <button class="btn btn-success btn-sm ct-btns" id="btnSaveCompany">Save</button>
                            <button class="btn btn-secondary btn-sm ct-btns" id="btnRefreshCompany">Refresh</button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-12 activeForm disabled">
                    <div class="commom-img mb-2 mt-1">
                        <img src="" id="ImageCompany" />
                    </div>
                    <div class="form-group">
                        <input class="form-control text-white" type="file" id="companyImg" accept="image/jpg, image/jpeg, image/png" />
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@section scripts{
    <script>


        $(function () {
            $(".AddPage").hide();
            CompanyList();
            $("#btnRefreshCompany").click();

            UserPageRights();
        });

        $(".btnAdd").click(function () {
            $(".ListPage").hide();
            $(".AddPage").show();
            $("#txtCompanyId").val('');
            $("#btnRefreshCompany").click();
        });

        $(".btnList").click(function () {
            $(".ListPage").show();
            $(".AddPage").hide();
        });


        function CompanyList(){
            try {
                $.ajax({
                    type: "Get",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    url: "/Settings/GetCompanyList/",
                    async: false,
                    dataType: "json",
                    success: function (data) {
                        $("#companyList").empty();

                        $.each(data, function (i, item) {

                            var autoPilotMode = "";
                            if (item.autoPilot == true) { autoPilotMode = "Yes" } else { autoPilotMode = "No" }

                            $("#companyList").append(`
                             <tr>
                                 <td class="companyId">${item.id}</td>
                                 <td class="companyName">${item.name}</td>
                                 <td class="companyEmail">${item.email}</td>
                                 <td class="companyTelephone">${item.telephone}</td>
                                 <td class="companyCity">${item.city}</td>
                                 <td class="companyPostalCode">${item.postalCode}</td>
                                 <td class="companyAddress1">${item.address1}</td>
                                 <td class="companyAddress2">${item.address2}</td>
                                 <td class="autoPilotMode">${autoPilotMode}</td>
                                 <td class="text-center last-td-sticky">
                                     <span class="me-3 btnEditCompany cursor-pointer" >
                                         <img src="/assets/img/icons/edit.svg" alt="img">
                                     </span>
                                     <span class="confirm-text btnDelCompany cursor-pointer" >
                                         <img src="/assets/img/icons/delete.svg" alt="img">
                                     </span>
                                 </td>
                                 <td class="companyImg d-none">${item.imgPath}</td>
                             </tr>
                            `)
                        })
                    },
                    error: function (data) {
                    }
                });
            }
            catch (err) {
                alert(err)
            }
        }


        $("#btnSaveCompany").click(function () {

            var id = $("#txtCompanyId").val();
            var name = $("#txtCompany").val();
            var email = $("#txtEmail").val();
            var telephone = $("#txtTelephone").val();
            var city = $("#txtCity").val();
            var postalcode = $("#txtPostalCode").val();
            var address1 = $("#txtAddress1").val();
            var address2 = $("#txtAddress2").val();
            
            var autoPilot = false;
            if($("#txtAutoPilot").is(":checked")){
                autoPilot = true;
            }

            var emailRegex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (email.length > 0) {
                if (!emailRegex.test(email)) {
                    toastr.warning("Invalid Email Address", "", { closeButton: !0, tapToDismiss: !1, ltl: o });
                    $('#txtEmail').focus();
                    return false;
                }
            }

            if (CheckValidation("AddPage") == false) {

                return false;
            }

            var formData = new FormData();

            var totalFiles = document.getElementById("companyImg").files.length;
            for (var i = 0; i < totalFiles; i++) {
                var file = document.getElementById("companyImg").files[i];
                formData.append("Image", file);
            }

            formData.append("id", id);
            formData.append("name", name);
            formData.append("email", email);
            formData.append("telephone", telephone);
            formData.append("city", city);
            formData.append("postalcode", postalcode);
            formData.append("address1", address1);
            formData.append("address2", address2);
            formData.append("autoPilot", autoPilot);
            formData.append("activityLogDateTime", moment().format('YYYY-MM-DD HH:mm:ss'));

            //CheckDuplicateEntry(NameMatch, LoopTableBodyId, TableDataNameMatchByClass, IgnoreValueId, IngoreValClassInTable)
            if (CheckDuplicateEntry($("#txtCompany").val(), "#companyList", ".companyName", $("#txtCompanyId").val(), ".companyId") == false) {
                toastr.info("Company Already Added.", "", { closeButton: !0, tapToDismiss: !1, ltl: o });
                $("#txtCompany").focus();
                return false;
            }

            try {
                $.ajax({
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    url: "/Settings/SaveCompany/",
                    data: formData,
                    async: false,
                    dataType: "json",
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data != false) {
                            toastr.success("Save Successfully", "", { closeButton: !0, tapToDismiss: !1, ltl: o });
                            CompanyList();
                            $("#btnRefreshCompany").click();
                        }
                        else {
                            toastr.error("Please Save Again", "", { closeButton: !0, tapToDismiss: !1, ltl: o });
                        }
                    },
                    error: function () {
                    }
                });
            }
            catch (err) {
                alert(err)
            }
        });


        $('body').on('click', ".btnDelCompany", function(){

            var x = confirm("Are you sure you want to delete?");
            if (x == false) { return false; }

            var obj = {};
            obj.id = $(this).closest('tr').find(".companyId").text();
            obj.imgName = $(this).closest('tr').find(".companyImg").text();
            obj.activityLogDateTime = moment().format('YYYY-MM-DD HH:mm:ss');

            try {
                $.ajax({
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    url: "/Settings/DelCompany/",
                    data: obj,
                    async: false,
                    dataType: "json",
                    success: function (data) {
                        if (data != false) {
                            toastr.success("Deleted Successfully", "", { closeButton: !0, tapToDismiss: !1, ltl: o });
                            CompanyList();
                        }
                        else {
                            toastr.error("Please Delete Again", "", { closeButton: !0, tapToDismiss: !1, ltl: o });
                        }
                    },
                    error: function () {
                    }
                });
            }
            catch (err) {
                alert(err)
            }
        });


        $("body").on('click', '.btnEditCompany', function () {

            $(".activeForm").removeClass('disabled');

            var companyId = $(this).closest('tr').find('.companyId').text();
            var companyName = $(this).closest('tr').find('.companyName').text();
            var companyEmail = $(this).closest('tr').find('.companyEmail').text();
            var companyTelephone = $(this).closest('tr').find('.companyTelephone').text();
            var companyCity = $(this).closest('tr').find('.companyCity').text();
            var companyPostalCode = $(this).closest('tr').find('.companyPostalCode').text();
            var companyAddress1 = $(this).closest('tr').find('.companyAddress1').text();
            var companyAddress2 = $(this).closest('tr').find('.companyAddress2').text();
            var autoPilotMode = $(this).closest('tr').find('.autoPilotMode').text();
            var companyImg = $(this).closest('tr').find('.companyImg').text();

            $("#txtCompanyId").val(companyId);
            $("#txtCompany").val(companyName);
            $("#txtEmail").val(companyEmail);
            $("#txtTelephone").val(companyTelephone);
            $("#txtCity").val(companyCity);
            $("#txtPostalCode").val(companyPostalCode);
            $("#txtAddress1").val(companyAddress1);
            $("#txtAddress2").val(companyAddress2);

            var path = window.location.origin;
            $("#ImageCompany").attr('src', path + "/" + companyImg);

            if(autoPilotMode == "Yes"){
                $("#txtAutoPilot").prop('checked', true);
            } else {
                $("#txtAutoPilot").prop('checked', false);
            }

            $("#btnSaveCompany").show();
            $("#btnNewCompany").hide();
            $("#btnSaveCompany").text('Update');

            $(".ListPage").hide();
            $(".AddPage").show();
        });


        //====================== Buttons ========================\\

        $("#btnNewCompany").click(function () {
            $(".activeForm").removeClass('disabled');
            
            $(this).hide();
            $("#btnSaveCompany").text('Save');
            $("#btnSaveCompany").show();
            $("#txtCompany").focus();

        });

        $("#btnRefreshCompany").click(function () {

            var uId = $("#txtCompanyId").val();

            if (uId != 0) {
                $(".companyId").each(function () {
                    const customerIdValue = $(this).text().trim();
                    if (customerIdValue === uId) {
                        $(this).closest('tr').find('.btnEditCompany').click();
                        return false;
                    }
                });
            }
            else {
                $(".activeForm").addClass('disabled');

                $("#btnSaveCompany").hide();
                $("#btnNewCompany").show();

                $("#txtCompanyId").val('');
                $("#txtCompany").val('');
                $("#txtEmail").val('');
                $("#txtTelephone").val('');
                $("#txtCity").val('');
                $("#txtPostalCode").val('');
                $("#txtAddress1").val('');
                $("#txtAddress2").val('');

                $("#txtAutoPilot").prop('checked', false);

                $("#ImageCompany").attr('src', '');
                $("#companyImg").val('');
            }
        });
        

        //====================== Input Validations ========================\\

        document.getElementById('txtTelephone').addEventListener('input', function (event) {
            const inputValue = event.target.value;
            event.target.value = inputValue.replace(/[^0-9+]/g, '');
        });

        //====================== Search ========================\\

        $(document).on('input', '#txtSearch', function () {
            var value = $(this).val().toLowerCase();
            $("#companyList tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });

        //====================== Company Image ========================\\
        $("body #companyImg").change(function (event) {
            $("#ImageCompany").attr('src', URL.createObjectURL(event.target.files[0]));
        });

        //====================== Word Convert ========================\\

        $('#convertWord').click(function () {
            $(".printCheckBox").trigger('change');

            HTMLtoWORD("tbl-print", "@ViewData["Title"]")
        });

        //====================== Grid Print Start ========================\\

        $('#pdfPrint').click(function () {
            $(".printCheckBox").trigger('change');

            var cloneTable = $("#tbl-print").clone();
            cloneTable.find('.d-none, .notPrintCol').remove();
            $(cloneTable).printThis();
        });

        //====================== Excel Convert ========================\\

        $("#convertExcel").click(function () {
            $(".printCheckBox").trigger('change');

            var cloneTable = $("#tbl-print").clone();
            cloneTable.find('.d-none, .notPrintCol').remove();

            TableToExcel.convert($(cloneTable)[0], {
                name: "@ViewData["Title"]" + ".xlsx",
                sheet: {
                    name: "@ViewData["Title"]"
                },

            });
        });

        //====================== Csv Convert ========================\\

        $("#convertCsv").click(function () {
            $(".printCheckBox").trigger('change');

            var cloneTable = $("#tbl-print").clone();
            cloneTable.find('.d-none, .notPrintCol').remove();

            var csvContent = "data:text/csv;charset=utf-8,";

            var headers = [];
            cloneTable.find("thead th").each(function () {
                headers.push($(this).text().trim());
            });

            csvContent += headers.join(",") + "\r\n";

            var tbody = cloneTable.find("tbody");

            tbody.find("tr").each(function () {
                var row = [];

                $(this).find("td").each(function () {
                    row.push($(this).text().trim());
                });

                csvContent += row.join(",") + "\r\n";
            });

            var encodedUri = encodeURI(csvContent);

            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "@ViewData["Title"]" + ".csv");

            document.body.appendChild(link);
            link.click();

            document.body.removeChild(link);
        });

        //================ Select Column By CheckBox ==================\\

        $(".printCheckBox").change(function () {
            const columnIndex = $(this).closest("th").index();
            const isChecked = $(this).is(":checked");
            const colClassToAdd = isChecked ? "PrintCol" : "notPrintCol";
            const colClassToRemove = isChecked ? "notPrintCol" : "PrintCol";

            $("#tbl-print tr").each(function () {
                const $cells = $(this).find(`th:eq(${columnIndex}), td:not(.d-none):eq(${columnIndex})`);
                $cells.removeClass(colClassToRemove).addClass(colClassToAdd);
            });
        });

        //================ User Page Rights ==================\\

        function UserPageRights() {

            try {
                $.ajax({
                    type: "Get",
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    url: "/User/UserPageRights/",
                    data: { url: window.location.pathname },
                    async: false,
                    dataType: "json",
                    success: function (data) {
                        if (data.word == false) { $("#convertWord").closest('li').remove(); }
                        if (data.pdf == false) { $("#pdfPrint").closest('li').remove(); }
                        if (data.excel == false) { $("#convertExcel").closest('li').remove(); }
                        if (data.csv == false) { $("#convertCsv").closest('li').remove(); }
                        if (data.delete == false) { $(".btnDelWorkOrder").remove(); }
                        if (data.edit == false) { $(".btnEditWorkOrder").remove(); }

                        if (data.save == false) {
                            $(".btnAdd").closest('div').remove();
                            $("#btnNewCompany, #btnSaveCompany, #btnRefreshCompany, .btnEditCompany, .btnDelCompany").remove();
                        }
                    },
                    error: function (data) {
                    }
                });
            }
            catch (err) {
                alert(err)
            }
        }

    </script>
}